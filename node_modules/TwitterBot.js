const Twitter = require('twitter-api-v2');
const db = require('mangodb');
const npmModule = require('npm-module');

const client = new Twitter({
    consumer_key: 'M4lDSa1ijJdPZSxho5DxQ8h0E',
    consumer_secret: 'SxcftDpzGspByVYB5rl1G0AK68Y0zd8y3aT8kD0kI0QmFDxA9e',
    access_token_key: '1402207041222021121-cB8HjDhM1eXeVvxIadT1bRC8AuFKHk',
    access_token_secret: '9sFzHEKNmsCpFFc6NFbHiV4SipIjyYZnbTANrWZBNIv4t'
});

// Track the ESTIAM hashtag
const stream = client.stream('statuses/filter', { track: 'ESTIAM' });

// When a tweet is received
stream.on('data', async function(event) {
    // Like the tweet
    client.post('favorites/create', { id: event.id_str }, function(error, tweet, response) {
        if (error) {
            console.log(error);
        } else {
            console.log(`Liked tweet with ID ${event.id_str}`);
        }
    });

    // Retweet the tweet
    client.post('statuses/retweet', { id: event.id_str }, function(error, tweet, response) {
        if (error) {
            console.log(error);
        } else {
            console.log(`Retweeted tweet with ID ${event.id_str}`);
        }
    });

    // Check if the user mentioning the hashtag has more than 100 followers
    const user = event.user;
    if (user.followers_count > 100) {
        // Follow the user
        client.post('friendships/create', { screen_name: user.screen_name }, function(error, tweet, response) {
            if (error) {
                console.log(error);
            } else {
                console.log(`Followed user ${user.screen_name}`);
            }
        });
    }
});

// When an error occurs
stream.on('error', function(error) {
    console.log(error);
});